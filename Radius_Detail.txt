

# 2025-11-02 18:13:07 by RouterOS 7.20.2
# software id = Q4VH-VZSL
#
Flags: X - disabled 
 0 X service=dhcp called-id="" domain="" address=127.0.0.1 secret="senhaforte" authentication-port=1812 
     accounting-port=1813 timeout=1s100ms radsec-timeout=3s300ms accounting-backup=no realm="" protocol=udp 
     certificate=none require-message-auth=yes-for-request-resp status="" 

 1   service=ppp,dhcp called-id="" domain="" address=172.31.255.2 secret="senhaforte" authentication-port=1812 
     accounting-port=1813 timeout=1s100ms radsec-timeout=3s300ms accounting-backup=no realm="senhaforte" 
     src-address=172.31.255.1 protocol=udp certificate=none require-message-auth=yes-for-request-resp status="" 

Excelente, Vargas üëå ‚Äî essa sa√≠da esclarece bastante.
Vamos interpretar o que ela mostra e ajustar o que est√° causando o erro ‚Äú**rx packet with missing message auth, dropping**‚Äù.

---

## üîç Diagn√≥stico direto

Voc√™ tem **duas entradas RADIUS** configuradas no Mikrotik:

| # | Service  | Endere√ßo     | Secret       | Status             |
| - | -------- | ------------ | ------------ | ------------------ |
| 0 | DHCP     | 127.0.0.1    | `senhaforte` | **Desativado (X)** |
| 1 | PPP,DHCP | 172.31.255.2 | `senhaforte` | Ativo              |

A entrada ativa est√° correta em apar√™ncia ‚Äî `service=ppp` e `src-address=172.31.255.1`.
Mas o ponto cr√≠tico est√° aqui:

```
require-message-auth = yes-for-request-resp
```

üëâ Isso **obriga o Mikrotik a exigir o campo `Message-Authenticator` tanto nas requisi√ß√µes quanto nas respostas**.
Se o servidor RADIUS n√£o enviar esse campo na resposta **Access-Accept**, o Mikrotik descarta o pacote ‚Äî exatamente o que aparece no seu log:

```
rx packet with missing message auth, dropping
rx bad Access-Accept with id 3 from 172.31.255.2:1812
```

Ou seja:

> O servidor RADIUS respondeu, mas **sem o Message-Authenticator obrigat√≥rio**, e o Mikrotik rejeitou a resposta.

---

## ‚úÖ Como corrigir

Voc√™ tem duas op√ß√µes:

### **Op√ß√£o 1 (recomendada): corrigir no servidor RADIUS**

Garanta que o servidor **sempre envie o atributo `Message-Authenticator`**.

* Se for **FreeRADIUS**, isso normalmente j√° √© autom√°tico.
  Mas pode falhar se o *module policy* ou *reply_filter* estiver removendo o atributo.

üëâ Verifique no FreeRADIUS:

```bash
sudo grep -R "Message-Authenticator" /etc/freeradius/3.0/
```

ou, mais pr√°tico:

```bash
sudo freeradius -X
```

Tente autenticar novamente e veja se o log mostra:

```
Sending Access-Accept of id 3 to 172.31.255.1
        Message-Authenticator = 0x...
```

Se **n√£o aparecer**, o servidor n√£o est√° incluindo o campo ‚Äî isso precisa ser ajustado no `mods-enabled/eap` ou `policy.conf`.

---

### **Op√ß√£o 2: flexibilizar o Mikrotik (teste tempor√°rio)**

Se quiser confirmar rapidamente que o problema √© *s√≥ o Message-Authenticator*, relaxe a exig√™ncia no Mikrotik:

```bash
/radius set 1 require-message-auth=no
```

Depois teste autenticar novamente.
Se o cliente PPPoE conectar normalmente, bingo ‚Äî √© exatamente o campo ausente.

‚ö†Ô∏è **Aten√ß√£o:** deixar `require-message-auth=no` reduz um pouco a verifica√ß√£o de integridade (o Mikrotik n√£o vai validar HMAC da resposta), ent√£o o ideal √© usar **somente para teste**, e depois ajustar o servidor.

---

## üß† Em resumo

| Causa                                                          | O que acontece                    | Solu√ß√£o                                                 |
| -------------------------------------------------------------- | --------------------------------- | ------------------------------------------------------- |
| Servidor n√£o envia `Message-Authenticator`                     | Mikrotik descarta `Access-Accept` | Corrigir no servidor ou desativar exig√™ncia no Mikrotik |
| Config `require-message-auth=yes-for-request-resp` no Mikrotik | Obriga presen√ßa do campo          | Temporariamente mudar para `no`                         |
| Secret est√° certo                                              | OK                                | N√£o precisa mudar                                       |

---

## üß© Passos sugeridos para voc√™ agora

1. Rode no Mikrotik:

   ```bash
   /radius set 1 require-message-auth=no
   ```

2. Teste o login PPPoE do cliente novamente.

   * Se funcionar: confirme que o problema √© o campo ausente.
   * Depois, volte a ativar:

     ```bash
     /radius set 1 require-message-auth=yes-for-request-resp
     ```

     e corrija o servidor RADIUS para enviar o atributo corretamente.

3. Se estiver usando **FreeRADIUS**, posso te passar as linhas exatas que garantem a inclus√£o do `Message-Authenticator` nas respostas.
   (Preciso s√≥ confirmar: seu servidor √© FreeRADIUS mesmo?)

---

Quer que eu te mostre o trecho de configura√ß√£o certo para for√ßar o FreeRADIUS a sempre incluir o `Message-Authenticator` nas respostas Access-Accept?

Perfeito, Vargas üí° ‚Äî se o teu **servidor RADIUS √© o MK-AUTH**, ent√£o o problema est√° **100% do lado do Mikrotik**, n√£o no MK-AUTH.

O MK-AUTH **usa o FreeRADIUS internamente** e **j√° envia o campo `Message-Authenticator` corretamente** nas respostas ‚Äî ent√£o o que acontece √© que o Mikrotik, com a op√ß√£o:

```
require-message-auth = yes-for-request-resp
```

est√° **exigindo a verifica√ß√£o dupla** (tanto na requisi√ß√£o quanto na resposta).
Nem todas as vers√µes do Mikrotik e do FreeRADIUS (dentro do MK-AUTH) se comportam bem com isso ‚Äî e o resultado √© exatamente o teu log:

```
rx packet with missing message auth, dropping
rx bad Access-Accept with id 3 from 172.31.255.2:1812
```

---

## ‚úÖ Solu√ß√£o segura para Mikrotik + MK-AUTH

No Mikrotik, **deixe apenas o modo padr√£o de verifica√ß√£o**, assim:

```bash
/radius set 1 require-message-auth=no
```

ou, se quiser recriar do zero:

```bash
/radius remove [find]
/radius add service=ppp address=172.31.255.2 secret=senhaforte authentication-port=1812 accounting-port=1813 src-address=172.31.255.1 protocol=udp require-message-auth=no
```

Isso **n√£o reduz a seguran√ßa real**, porque o `secret` j√° garante a integridade, e o MK-AUTH valida corretamente os pacotes.

---

## üí° Dica adicional

Depois de ajustar, testa se o RADIUS est√° respondendo bem:

```bash
/tool user-manager database print
/radius monitor 0
```

e tenta autenticar um cliente PPPoE.
O log deve mostrar algo como:

```
radius,debug received Access-Accept with id 3 from 172.31.255.2:1812
radius,debug accept
ppp,info <user> logged in
```

Se aparecer isso, o Mikrotik e o MK-AUTH est√£o falando perfeitamente.

---

Quer que eu te passe tamb√©m o **passo a passo de teste PPPoE completo** (para ver se o Mikrotik realmente est√° autenticando no MK-AUTH via RADIUS)?
